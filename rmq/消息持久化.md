# 消息持久化

## 持久化问题
默认情况下，当重启rabbitmq时，里面的队列和交换机（连同里面的消息）就都消息了。  
原因在于durable默认设置是false。durable决定了rabbitmq在崩溃或重启之后是否要重新创建队列（或交换机）。 <mark>但是光设置durable为ture后，消息也不能避免在重新出现</mark>。  
以下三步设置能保证消息不会在重启中丢失。  

1. 把投递模式设置为2，即把消息标志为持久化。  
2. 发送到持久化的交换机中。  
3. 投递到持久化的队列中。  
**不丢失的原因是，rabbitmq把消息写进磁盘的持久化文件中**  
**同时，rabbitmq在消息写入持久化文件后才返回**  

## 持久化后存在的问题
1. rabbitmq持久化后会极大的减少消息处理速度。
2. 在集群中，队列分散在各个节点上。一旦节点崩了，直到恢复前，这个队列就在集群中消息不见了。（如果队列时可持久化的）
3. **更重要的是** 节点崩溃后，节点上的其他队列也不可以用了，持久化队列也无法重建。这会导致消息丢失。

## AMQP事务
保证了一个消息送达。但是它会榨干rabbitmq的性能，使吞吐量降低2-10倍。而且会使应用程序产生同步。而使用消息队列的目的就是避免同步。因此有更好的处理方案 **发送发确认模式**。当确认了消息已经安全达到目的队列时，生产者应用的回调方法会被触发来处理该确认消息。如果没有成功到达，会回复nack。  
