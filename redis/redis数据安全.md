## redis复制的启动过程
当从服务器连接到主服务器时，主服务器会创建一个快照文件并将其发送到从服务器。具体过程如下：  

步骤  |  主服务器操作  |  从服务器操作 
----- | ------ | -------
1 | （等待命令进入） | 连接(或重新连接)主服务器，发送sync命令
2 |开始执行BGSAVE命令，并使用缓冲区记录BGSAVE执行时所有的写命令 |根据配置选项确定是使用现有数据相应客户端请求还是向发送请求的客户端发回错误信息
3 | BGSAVE执行完成，并向从服务器发送数据。在此期间仍然用缓冲区记录写命令 | 丢弃所有旧数据，开始载入主服务器发来的快照文件
4 | 快照文件发送完成，开始向从服务器发送缓冲区的写命令 | 完成对快照文件的解释操作，像往常一样开始接受命令请求
5 | 缓冲区写命令发送完毕；从现在开始，每执行一个写命令，就向从服务器发送相同的写命令 | 执行主服务器的所有缓冲区写命令；并从现在开始，接受并执行主服务器传来的每个写命令

<mark>实际中最好让主服务器只使用50%-65%的内存，留下35%-45%的内存用于执行BGSAVE和创建记录写命令的缓冲区。<mark>

## 检查硬盘写入
1. 为了验证主服务器是否已经将数据写入到了从服务器中，用户需要在写入真正的数据之后，再向主服务器写入 **唯一的虚构值**，然后通过判断虚构值是否存在于 **从服务器**，最终确定数据是否写入到从服务器中。 
2. 判断数据是否已经保存到磁盘中，检查INFO命令输出结果中的aof_pending_bio_fsync属性值是否为0。是的话，表示已经同步成功。

## 处理系统故障
redis-check-aof和redis-check-dump，它们可以在故障发生之后检查AOF和快照文件的状态。  
如果在redis-check-aof之后加 --fix参数，那么程序会对aof文件进行修复。修复的方法很简单，将出问题的行及其之后所有的命令都删除。  
<mark>目前没有方法修复出错的 **快照文件** <mark>
### 更换故障主服务器
譬如：有A主服务器和B从服务器。现在A服务器发生了故障，需要用安装了redis的C服务器代替。  

* 方法一  
	1. 向B服务器发送一个SAVE命令，让其创建一个快照文件
	2. 将1中的快照文件发送给C，并启动redis
	3. 让机器B称为C的从服务器

* 方法二
	1. 将B服务器设置为主服务器
	2. 设置B的从服务器
 
## redis事务
redis的事务和关系型数据库中的事务不同。redis的事务以 **MULTI** 起 **EXEC** 结束，在exec之前，redis并不会去执行任何命令。  
一般的redis客户端实现都是等exec命令之后，才将命令一次性提交给redis。<mark>可以减少通信的次数，提高性能<mark>  

事务失败的几种情况：
	1. 其中一句语法错误，2.6.5之后的版本直接不执行
	2. 语法正确，但实际执行时有错误，则忽略该条，其余的正常执行。