
# redis数据安全

## 持久化
redis中的数据都是在内存中的，持久化就是将内存中的数据存储到硬盘里面。  
**注意**：不要在关闭主服务器持久化服务后设置自动拉起。

### 快照RDB
将某一时刻的所有数据都写到硬盘中  
1. 在快照备份期间，只是备份开始时刻的数据。譬如在下午2：05分开始备份，2：08分备份成功。在此期间有30个键的数据更改。若之后数据奔溃， 恢复数据后，会丢失这30个键的数据。  
2. 如果调用了BGSAVE命令，redis会fork一个新的进程，然后子进程负责写入硬盘，父进程继续处理命令请求。  
3. 调用了SAVE命令，则redis在快照创建完成之前不再响应任何其他命令。  
4. 收到SHUTDOWN和标准TERM信号时，会执行一个 **SAVE** 命令。并在执行完毕之后关闭服务器。    

---
由于快照方式会丢在最近快照点和奔溃点之间的数据，因此只适用于即使丢一部分数据也不会造成问题的应用程序。

### AOF
执行写命令时，将执行的写命令复制到硬盘里面。当需要恢复数据时，从头到尾执行一遍aof文件的命令即可。  
**注意**：在固态硬盘中，谨慎使用append always选项。会严重损害硬盘寿命。  
使用BGREWRITEAOF（GB REWRITE AOF），会重写AOF文件，移出其中的冗余命令。譬如：连续对同一个key值加一操作，重写后会变成对一个key值加100操作。  
重写AOF文件，和BGSAVE类似。redis会创建一个子进程，然后由子进程对AOF文件重写。  

---
持久化总结：在开启RDB或者AOF之后，还必须对所得的文件进行备份。如果条件允许，最好能将快照文件和最新重写的AOF文件备份到不同的服务器上。  

## 复制
让其他服务器拥有一个不断更新的数据副本，从而使得拥有数据副本的服务器可以用于处理客户端发送的请求。redis采用的是 **一主多从** 来实现自己的复制特性。让从服务器来处理所有的读请求。  
从服务器在启动的时候， **必须要包含salve of host port** 选项。

## redis复制的启动过程
当从服务器连接到主服务器时，主服务器会创建一个快照文件并将其发送到从服务器。具体过程如下：  

步骤  |  主服务器操作  |  从服务器操作 
----- | ------ | -------
1 | （等待命令进入） | 连接(或重新连接)主服务器，发送sync命令
2 |开始执行BGSAVE命令，并使用缓冲区记录BGSAVE执行时所有的写命令 |根据配置选项确定是使用现有数据相应客户端请求还是向发送请求的客户端发回错误信息
3 | BGSAVE执行完成，并向从服务器发送数据。在此期间仍然用缓冲区记录写命令 | 丢弃所有旧数据，开始载入主服务器发来的快照文件
4 | 快照文件发送完成，开始向从服务器发送缓冲区的写命令 | 完成对快照文件的解释操作，像往常一样开始接受命令请求
5 | 缓冲区写命令发送完毕；从现在开始，每执行一个写命令，就向从服务器发送相同的写命令 | 执行主服务器的所有缓冲区写命令；并从现在开始，接受并执行主服务器传来的每个写命令

<mark>实际中最好让主服务器只使用50%-65%的内存，留下35%-45%的内存用于执行BGSAVE和创建记录写命令的缓冲区。<mark>

## 检查硬盘写入
1. 为了验证主服务器是否已经将数据写入到了从服务器中，用户需要在写入真正的数据之后，再向主服务器写入 **唯一的虚构值**，然后通过判断虚构值是否存在于 **从服务器**，最终确定数据是否写入到从服务器中。 
2. 判断数据是否已经保存到磁盘中，检查INFO命令输出结果中的aof_pending_bio_fsync属性值是否为0。是的话，表示已经同步成功。

## 处理系统故障
redis-check-aof和redis-check-dump，它们可以在故障发生之后检查AOF和快照文件的状态。  
如果在redis-check-aof之后加 --fix参数，那么程序会对aof文件进行修复。修复的方法很简单，将出问题的行及其之后所有的命令都删除。  
<mark>目前没有方法修复出错的 **快照文件** <mark>
### 更换故障主服务器
譬如：有A主服务器和B从服务器。现在A服务器发生了故障，需要用安装了redis的C服务器代替。  

* 方法一  
	1. 向B服务器发送一个SAVE命令，让其创建一个快照文件
	2. 将1中的快照文件发送给C，并启动redis
	3. 让机器B称为C的从服务器

* 方法二
	1. 将B服务器设置为主服务器
	2. 设置B的从服务器
 
## redis事务
redis的事务和关系型数据库中的事务不同。redis的事务以 **MULTI** 起 **EXEC** 结束，在exec之前，redis并不会去执行任何命令。  
一般的redis客户端实现都是等exec命令之后，才将命令一次性提交给redis。<mark>可以减少通信的次数，提高性能<mark>  

事务失败的几种情况：
	1. 其中一句语法错误，2.6.5之后的版本直接不执行
	2. 语法正确，但实际执行时有错误，则忽略该条，其余的正常执行。